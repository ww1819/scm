<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
	<th:block th:include="include :: header('订单列表')" />
	<th:block th:include="include :: layout-latest-css" />
</head>
<body class="gray-bg">
	<div class="container-div">
		<div class="row">
			<div class="col-sm-12 search-collapse">
				<form id="order-form">
					<div class="select-list">
						<ul>
							<li>
								订单编号：<input type="text" name="orderNo"/>
							</li>
							<li>
								医院名称：<input type="text" name="hospitalName"/>
							</li>
							<li>
								供应商名称：<input type="text" name="supplierName"/>
							</li>
							<li>
								订单状态：<select name="orderStatus">
									<option value="">所有</option>
									<option value="0">待接收</option>
									<option value="1">已接收</option>
									<option value="2">配送中</option>
									<option value="3">已完成</option>
									<option value="4">已取消</option>
								</select>
							</li>
							<li class="select-time">
								<label>订单日期： </label>
								<input type="text" class="time-input" id="startTime" placeholder="开始时间" name="params[beginTime]"/>
								<span>-</span>
								<input type="text" class="time-input" id="endTime" placeholder="结束时间" name="params[endTime]"/>
							</li>
							<li>
								<a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i class="fa fa-search"></i>&nbsp;搜索</a>
								<a class="btn btn-warning btn-rounded btn-sm" onclick="resetPre()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
							</li>
						</ul>
					</div>
				</form>
			</div>
			
	        <div class="btn-group-sm" id="toolbar" role="group">
	        	<a class="btn btn-success" onclick="$.operate.addTab()" shiro:hasPermission="order:order:add">
	                <i class="fa fa-plus"></i> 新增
	            </a>
	             <a class="btn btn-primary single disabled" onclick="$.operate.editTab()" shiro:hasPermission="order:order:edit">
		            <i class="fa fa-edit"></i> 修改
		        </a>
	            <a class="btn btn-danger multiple disabled" onclick="$.operate.removeAll()" shiro:hasPermission="order:order:remove">
	                <i class="fa fa-remove"></i> 删除
	            </a>
	            <a class="btn btn-info multiple disabled" onclick="receiveOrder()" shiro:hasPermission="order:order:receive">
	                <i class="fa fa-check"></i> 接收订单
	            </a>
	            <a class="btn btn-warning" onclick="$.table.exportExcel()" shiro:hasPermission="order:order:export">
		            <i class="fa fa-download"></i> 导出
		        </a>
	        </div>
	        
	        <div class="col-sm-12 select-table table-striped">
			    <table id="bootstrap-table"></table>
			</div>
		</div>
	</div>
	
	<th:block th:include="include :: footer" />
	<th:block th:include="include :: layout-latest-js" />
	<script th:inline="javascript">
		var editFlag = [[${@permission.hasPermi('order:order:edit')}]];
		var removeFlag = [[${@permission.hasPermi('order:order:remove')}]];
		var detailFlag = [[${@permission.hasPermi('order:order:detail')}]];
		var receiveFlag = [[${@permission.hasPermi('order:order:receive')}]];
		var prefix = ctx + "order/order";

		$(function() {
		    queryOrderList();
		});

		function queryOrderList() {
		    var options = {
		        url: prefix + "/list",
		        createUrl: prefix + "/add",
		        updateUrl: prefix + "/edit/{id}",
		        removeUrl: prefix + "/remove",
		        exportUrl: prefix + "/export",
		        sortName: "orderDate",
		        sortOrder: "desc",
		        modalName: "订单",
		        columns: [{
		            checkbox: true
		        },
		        {
		            field: 'orderId',
		            title: '订单ID',
		            visible: false
		        },
		        {
		            field: 'index',
		            title: '序号',
		            align: 'center',
		            width: 60,
		            formatter: function(value, row, index) {
		                return index + 1;
		            }
		        },
		        {
		            field: 'orderNo',
		            title: '订单编号',
		            sortable: true,
		            formatter: function (value, row, index) {
		                return '<a href="javascript:void(0)" onclick="viewDetail(\'' + row.orderId + '\')">' + value + '</a>';
		            }
		        },
		        {
		            field: 'hospitalName',
		            title: '医院名称',
		            formatter: function (value, row, index) {
		                return value || '-';
		            }
		        },
		        {
		            field: 'supplierName',
		            title: '供应商名称',
		            formatter: function (value, row, index) {
		                return value || '-';
		            }
		        },
		        {
		            field: 'orderAmount',
		            title: '订单金额',
		            formatter: function (value, row, index) {
		                if (value) {
		                    return '¥' + parseFloat(value).toFixed(2);
		                }
		                return '¥0.00';
		            }
		        },
		        {
		            field: 'warehouse',
		            title: '要货仓库'
		        },
		        {
		            field: 'orderDate',
		            title: '订单日期',
		            sortable: true
		        },
		        {
		        	title: '订单状态',
		        	align: 'center',
		        	formatter: function (value, row, index) {
		        		var statusMap = {
		        			'0': '<span class="label label-warning">待接收</span>',
		        			'1': '<span class="label label-info">已接收</span>',
		        			'2': '<span class="label label-primary">配送中</span>',
		        			'3': '<span class="label label-success">已完成</span>',
		        			'4': '<span class="label label-danger">已取消</span>'
		        		};
		        		return statusMap[row.orderStatus] || '';
		        	}
		        },
		        {
		            field: 'department',
		            title: '申请科室'
		        },
		        {
		            title: '操作',
		            align: 'center',
		            formatter: function(value, row, index) {
		            	var actions = [];
		                actions.push('<a class="btn btn-info btn-xs ' + detailFlag + '" href="javascript:void(0)" onclick="viewDetail(\'' + row.orderId + '\')"><i class="fa fa-eye"></i>详情</a> ');
		                actions.push('<a class="btn btn-success btn-xs ' + editFlag + '" href="javascript:void(0)" onclick="$.operate.editTab(\'' + row.orderId + '\')"><i class="fa fa-edit"></i>编辑</a> ');
		                actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.orderId + '\')"><i class="fa fa-remove"></i>删除</a> ');
		                if (row.orderStatus == '0' && receiveFlag != 'hidden') {
		                	actions.push('<a class="btn btn-primary btn-xs" href="javascript:void(0)" onclick="receiveSingleOrder(\'' + row.orderId + '\')"><i class="fa fa-check"></i>接收</a> ');
		                }
		                return actions.join('');
		            }
		        }]
		    };
		    $.table.init(options);
		}
		
		/* 自定义重置 */
		function resetPre() {
			resetDate();
			$("#order-form")[0].reset();
			$.table.search();
		}

		/* 查看订单详情 */
		function viewDetail(orderId) {
		    var url = prefix + '/detail/' + orderId;
		    $.modal.openTab("订单详情", url);
		}

		/* 接收订单 */
		function receiveOrder() {
			var ids = $.table.selectColumns();
			if (ids.length == 0) {
				$.modal.msgWarning("请选择要接收的订单");
				return;
			}
			$.modal.confirm("确认要接收选中的订单吗？", function() {
				$.operate.post(prefix + "/receive", { "ids": ids.join(",") });
		    });
		}

		/* 接收单个订单 */
		function receiveSingleOrder(orderId) {
			$.modal.confirm("确认要接收该订单吗？", function() {
				$.operate.post(prefix + "/receive", { "ids": orderId });
		    });
		}
	</script>
</body>
</html>

