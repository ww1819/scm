<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
	<th:block th:include="include :: header('供应商资质审核')" />
	<th:block th:include="include :: layout-latest-css" />
	<style>
		/* 表格列不换行 */
		#bootstrap-table td,
		#bootstrap-table th {
			white-space: nowrap !important;
			overflow: hidden;
			text-overflow: ellipsis;
		}
		
		/* 表格容器支持水平滚动 */
		.select-table {
			overflow-x: auto !important;
			overflow-y: auto;
		}
		
		/* 表格固定最小宽度，确保列不会被压缩 */
		#bootstrap-table {
			min-width: 1200px;
		}
		
		/* Bootstrap Table 固定表头时也支持横向滚动 */
		.fixed-table-body {
			overflow-x: auto !important;
		}
		
		/* 确保表格内容区域可以横向滚动 */
		.bootstrap-table .fixed-table-container {
			overflow-x: auto !important;
		}
		
		/* 固定表头样式 */
		.fixed-table-header {
			position: sticky !important;
			top: 0 !important;
			z-index: 10 !important;
			background-color: #fff !important;
		}
		
		.fixed-table-header thead th {
			background-color: #f5f5f5 !important;
			border-bottom: 2px solid #ddd !important;
		}
		
		/* 确保固定表头在滚动时保持可见 */
		.bootstrap-table .fixed-table-container .fixed-table-header {
			position: relative;
		}
		
		.bootstrap-table .fixed-table-container.has-fixed-columns .fixed-table-header {
			position: sticky;
			top: 0;
			z-index: 10;
		}
		
		/* 详情框样式 */
		#detail-panel {
			transition: all 0.3s ease;
			height: calc(100vh - 500px) !important;
			min-height: 300px;
			max-height: none !important;
			display: flex;
			flex-direction: column;
		}
		
		/* 详情框表格容器，固定表头 */
		#detail-panel .row {
			flex: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}
		
		#detail-panel .col-sm-12 {
			flex: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}
		
		/* 详情框表格，固定表头 */
		#detail-panel table {
			margin-bottom: 0;
			display: flex;
			flex-direction: column;
			height: 100%;
		}
		
		#detail-panel thead {
			display: block;
			flex-shrink: 0;
		}
		
		#detail-panel thead tr {
			display: table;
			width: 100%;
			table-layout: fixed;
		}
		
		#detail-panel tbody {
			display: block;
			flex: 1;
			overflow-y: auto;
			overflow-x: hidden;
		}
		
		#detail-panel tbody tr {
			display: table;
			width: 100%;
			table-layout: fixed;
		}
		
		/* 确保表头和表体列宽一致 */
		#detail-panel thead th,
		#detail-panel tbody td {
			width: auto;
		}
		
		/* 优化间距 */
		.search-collapse {
			margin-bottom: 10px;
		}
		
		/* 表格容器固定高度 */
		.select-table {
			position: relative;
		}
		
		/* 医院表格样式 */
		#bootstrap-table-hospital {
			visibility: visible !important;
		}
		
		/* 医院表格容器样式 */
		#bootstrap-table-hospital + .fixed-table-container {
			visibility: visible !important;
			display: block !important;
		}
		
		/* 确保医院表格容器可见 */
		.col-sm-3 .select-table {
			overflow: auto !important;
			visibility: visible !important;
		}
		
		/* 医院表格固定表头容器 */
		.col-sm-3 .fixed-table-container {
			height: 100% !important;
			overflow: visible !important;
		}
		
		.col-sm-3 .fixed-table-body {
			overflow-y: auto !important;
			overflow-x: hidden !important;
		}
		
		/* 确保左侧医院面板可见 */
		.col-sm-3 {
			display: block !important;
			visibility: visible !important;
			position: fixed !important;
			left: 0 !important;
			top: 0 !important;
			bottom: 0 !important;
			width: 25% !important;
			z-index: 100 !important;
		}
		
		/* 确保医院表格元素存在且可见 */
		#bootstrap-table-hospital {
			display: table !important;
			visibility: visible !important;
		}
	</style>
</head>
<body class="gray-bg">
	<div class="container-div" style="position: relative;">
		<div class="row">
			<!-- 左侧：医院列表 -->
			<div class="col-sm-3" style="border-right: 1px solid #e7eaec; padding-right: 10px; position: fixed; left: 0; top: 0; bottom: 0; width: 25%; overflow: hidden; z-index: 100;">
				<div class="panel panel-default" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%;">
					<div class="panel-heading" style="padding: 5px 10px; flex-shrink: 0;">
						<h5 class="panel-title" style="margin: 0; font-size: 14px;">
							<i class="fa fa-hospital-o"></i> 医院
						</h5>
					</div>
					<!-- 搜索框 -->
					<div style="padding: 8px 10px; flex-shrink: 0; border-bottom: 1px solid #e7eaec; background: #f5f5f5;">
						<div class="input-group" style="width: 100%;">
							<input type="text" id="hospital-search-input" class="form-control" placeholder="搜索医院名称或编码..." style="height: 30px; font-size: 12px; padding: 5px 10px;">
							<span class="input-group-btn" style="width: auto;">
								<button class="btn btn-default" type="button" onclick="searchHospital()" style="height: 30px; padding: 0 10px; font-size: 12px;">
									<i class="fa fa-search"></i>
								</button>
								<button class="btn btn-default" type="button" onclick="clearHospitalSearch()" style="height: 30px; padding: 0 10px; font-size: 12px;">
									<i class="fa fa-times"></i>
								</button>
							</span>
						</div>
					</div>
					<div class="panel-body" style="padding: 5px; flex: 1; overflow: auto; display: flex; flex-direction: column; min-height: 0;">
						<div class="select-table table-striped" style="flex: 1; overflow: visible; min-height: 0; width: 100%; position: relative;">
							<table id="bootstrap-table-hospital" style="width: 100%;"></table>
						</div>
					</div>
				</div>
			</div>
			
			<!-- 右侧：供应商证件审核列表 -->
			<div class="col-sm-9" style="position: fixed; left: 25%; top: 0; bottom: 0; right: 0; width: 75%; overflow: hidden; z-index: 99; display: flex; flex-direction: column; background: #fff;">
				<div class="col-sm-12 search-collapse" style="flex-shrink: 0;">
					<form id="supplier-certificate-form">
						<div class="select-list">
							<ul>
								<li>
									供应商名称：<input type="text" name="supplierName"/>
								</li>
								<li>
									证件类型：<input type="text" name="certificateType"/>
								</li>
								<li>
									状态：
									<select name="auditStatusFilter" id="auditStatusFilter" style="width: 120px; display: inline-block; height: 30px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;">
										<option value="">全部</option>
										<option value="1">已审核</option>
										<option value="0">待审核</option>
									</select>
								</li>
								<li>
									<a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i class="fa fa-search"></i>&nbsp;搜索</a>
									<a class="btn btn-warning btn-rounded btn-sm" onclick="resetPre()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
								</li>
							</ul>
						</div>
					</form>
				</div>
				
		        <div class="btn-group-sm" id="toolbar" role="group" style="flex-shrink: 0; padding: 5px 10px; margin-bottom: 10px;">
		            <button type="button" class="btn btn-info single disabled" onclick="auditCertificate()" shiro:hasPermission="certificate:supplier:audit">
		                <i class="fa fa-check"></i> 审核
		            </button>
		        </div>
		        
		        <div class="col-sm-12 select-table table-striped" style="height: 400px; overflow: hidden; padding: 0 10px; margin-bottom: 5px;">
			    <table id="bootstrap-table"></table>
			    <!-- 详情框将动态插入到这里，在分页信息之后 -->
			</div>
			
			<!-- 详情框（初始位置，将通过JS移动到分页信息下方） -->
			<div id="detail-panel" class="col-sm-12" style="flex-shrink: 0; border: 1px solid #e7eaec; border-radius: 4px; padding: 15px; background: #f9f9f9; display: none; height: calc(100vh - 500px); min-height: 300px; overflow-y: auto; margin-bottom: 10px; margin-top: 0;">
				<h5 style="margin-top: 0; margin-bottom: 15px; font-weight: bold;">
					<i class="fa fa-info-circle"></i> 证件详情
				</h5>
				<div class="row">
					<div class="col-sm-12">
						<table class="table table-bordered table-condensed" style="margin-bottom: 0;">
							<thead>
								<tr style="background-color: #f5f5f5;">
									<th style="width: 80px; text-align: center;">序号</th>
									<th style="width: 150px; text-align: center;">证件类型</th>
									<th style="width: 200px; text-align: center;">证件编码</th>
									<th style="width: 120px; text-align: center;">有效期</th>
									<th style="width: 100px; text-align: center;">是否长期</th>
									<th style="text-align: center;">证件图片</th>
								</tr>
							</thead>
							<tbody id="detail-tbody">
								<tr>
									<td colspan="6" style="text-align: center; color: #999;">请选择一行查看详情</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
			</div>
		</div>
	</div>
	
	<th:block th:include="include :: footer" />
	<th:block th:include="include :: layout-latest-js" />
	<script th:inline="javascript">
		var prefix = ctx + "certificate/supplier";
		var hospitalPrefix = ctx + "hospital/hospital";
		var selectedHospitalId = null; // 当前选中的医院ID
		var selectedSupplierIds = []; // 当前选中的供应商ID列表

		$(function() {
		    // 先初始化医院列表（与supplier.html保持一致）
		    initHospitalTable();
		    
		    // 然后初始化供应商证件审核列表（只显示待审核的）
		    querySupplierCertificateAuditList();
		    
		    // 监听窗口大小改变事件
		    $(window).resize(function() {
		        adjustSupplierTableHeight();
		    });
		    
		    // 初始化时调整表格高度
		    setTimeout(function() {
		        adjustSupplierTableHeight();
		    }, 300);
		});
		
		// 调整供应商证件表格高度（固定高度，不再动态调整）
		function adjustSupplierTableHeight() {
		    // 表格高度固定为400px，不再动态调整
		    $('#bootstrap-table').bootstrapTable('resetView', {
		        height: 400
		    });
		}

		function querySupplierCertificateAuditList() {
		    // 计算表格高度（固定高度，不再动态计算）
		    var calculateTableHeight = function() {
		        // 固定表格高度为400px
		        return 400;
		    };
		    
		    var options = {
		        url: prefix + "/list",
		        uniqueId: "certificateId",  // 设置唯一ID字段，用于复选框选择
		        queryParams: function(params) {
		            // 根据状态筛选框的值进行筛选
		            var auditStatusFilter = $('#auditStatusFilter').val();
		            if (auditStatusFilter !== '') {
		                params.auditStatus = auditStatusFilter;
		            }
		            // 如果选中了医院，传递该医院绑定的供应商ID列表和医院ID
		            if (selectedHospitalId && selectedSupplierIds && selectedSupplierIds.length > 0) {
		                params.supplierIds = selectedSupplierIds.join(',');
		                params.hospitalId = selectedHospitalId;
		            }
		            return params;
		        },
		        sortName: "createTime",
		        sortOrder: "desc",
		        modalName: "供应商证件",
		        height: calculateTableHeight(),
		        fixedColumns: false,
		        fixedNumber: 0,
		        onCheck: function(row) {
		            updateToolbarState();
		        },
		        onUncheck: function(row) {
		            updateToolbarState();
		        },
		        onCheckAll: function(rows) {
		            updateToolbarState();
		        },
		        onUncheckAll: function() {
		            updateToolbarState();
		        },
		        onClickRow: function(row, $element) {
		            // 移除其他行的选中样式
		            $('#bootstrap-table tbody tr').removeClass('selected');
		            // 添加当前行的选中样式
		            $element.addClass('selected');
		            // 显示选中行的详情
		            showDetail(row);
		        },
		        columns: [{
		            checkbox: true
		        },
		        {
		            title: '审核',
		            align: 'center',
		            width: 80,
		            formatter: function (value, row, index) {
		                if (row.auditStatus == '1') {
		                    return '<span class="label label-success">是</span>';
		                } else if (row.auditStatus == '2') {
		                    return '<span class="label label-danger">否</span>';
		                } else {
		                    return '<span class="label label-warning">待审核</span>';
		                }
		            }
		        },
		        {
		            field: 'serialNumber',
		            title: '序号',
		            align: 'center',
		            width: 60,
		            formatter: function (value, row, index) {
		                return $.table.serialNumber(index);
		            }
		        },
		        {
		            field: 'certificateId',
		            title: '证件ID',
		            visible: false
		        },
		        {
		            field: 'supplierId',
		            title: '供应商ID',
		            visible: false
		        },
		        {
		            field: 'supplierCode',
		            title: '供应商编码',
		            align: 'left',
		            width: 150,
		            formatter: function (value, row, index) {
		                return value || '-';
		            }
		        },
		        {
		            field: 'supplierName',
		            title: '供应商名称',
		            align: 'left',
		            width: 200,
		            formatter: function (value, row, index) {
		                return value || '-';
		            }
		        },
		        {
		            field: 'hospitalCode',
		            title: '医院编码',
		            align: 'left',
		            width: 150,
		            formatter: function (value, row, index) {
		                return value || '-';
		            }
		        },
		        {
		            field: 'hospitalName',
		            title: '医院名称',
		            align: 'left',
		            width: 200,
		            formatter: function (value, row, index) {
		                return value || '-';
		            }
		        },
		        {
		            field: 'contactPerson',
		            title: '公司联系人',
		            align: 'left',
		            width: 120,
		            formatter: function (value, row, index) {
		                return value || '-';
		            }
		        },
		        {
		            field: 'address',
		            title: '公司地址',
		            align: 'left',
		            width: 300,
		            formatter: function (value, row, index) {
		                return value || '-';
		            }
		        }]
		    };
		    
		    // 在表格初始化后，将详情框移动到分页信息下方
		    options.onPostBody = function() {
		        moveDetailPanelToPagination();
		    };
		    
		    // 监听表格加载成功事件
		    options.onLoadSuccess = function(data) {
		        moveDetailPanelToPagination();
		    };
		    
		    $.table.init(options);
		    
		    // 延迟执行一次，确保分页信息已渲染
		    setTimeout(function() {
		        moveDetailPanelToPagination();
		    }, 500);
		}
		
		// 将详情框移动到分页信息下方
		function moveDetailPanelToPagination() {
		    var $table = $('#bootstrap-table');
		    var $tableContainer = $table.closest('.select-table');
		    var $pagination = $tableContainer.find('.fixed-table-pagination');
		    var $detailPanel = $('#detail-panel');
		    
		    if ($pagination.length > 0 && $detailPanel.length > 0) {
		        // 如果详情框已经在分页信息之后，就不需要移动
		        if ($detailPanel.prev().hasClass('fixed-table-pagination')) {
		            return;
		        }
		        
		        // 将详情框移动到分页信息之后（在表格容器内）
		        $pagination.after($detailPanel);
		        
		        // 调整详情框样式，确保它在表格容器内正确显示
		        $detailPanel.css({
		            'margin-top': '10px',
		            'margin-bottom': '10px',
		            'width': '100%',
		            'height': 'calc(100vh - 500px)',
		            'min-height': '300px',
		            'max-height': 'none'
		        });
		    }
		}
		
		function resetPre() {
			$("#supplier-certificate-form")[0].reset();
			// 重置状态筛选框为"全部"
			$("#auditStatusFilter").val('');
			$.table.search();
		}
		
		// 计算医院表格高度
		function calculateHospitalTableHeight() {
		    var windowHeight = $(window).height();
		    var panelHeaderHeight = 35;
		    var searchHeight = 46;
		    var bodyPadding = 10;
		    return windowHeight - panelHeaderHeight - searchHeight - bodyPadding - 20;
		}
		
		// 初始化医院表格（与supplier.html的initSupplierTable保持一致）
		function initHospitalTable() {
		    var $table = $('#bootstrap-table-hospital');
		    console.log("初始化医院表格，表格元素数量:", $table.length);
		    
		    if ($table.length === 0) {
		        console.warn("医院表格元素不存在，300ms后重试");
		        setTimeout(function() {
		            initHospitalTable();
		        }, 300);
		        return;
		    }
		    
		    var tableHeight = calculateHospitalTableHeight();
		    console.log("医院表格高度:", tableHeight);
		    
		    try {
		        $table.bootstrapTable({
		        data: [],
		        pagination: false,
		        search: false,
		        showRefresh: false,
		        showColumns: false,
		        showToggle: false,
		        height: tableHeight,
		        striped: true,
		        classes: 'table table-condensed',
		        locale: 'zh-CN',
		        showHeader: true,
		        showEmptyRows: false,
		        columns: [{
		            field: 'hospitalCode',
		            title: '医院编码',
		            sortable: true,
		            width: 120,
		            cellStyle: {fontSize: '12px', padding: '4px'},
		            formatter: function(value, row, index) {
		                return value || '-';
		            }
		        },
		        {
		            field: 'hospitalName',
		            title: '医院名称',
		            cellStyle: {fontSize: '12px', padding: '4px'},
		            formatter: function(value, row, index) {
		                if (!value) return '-';
		                var hospitalId = row.hospitalId || '';
		                return '<a href="javascript:void(0)" onclick="selectHospital(\'' + hospitalId + '\')" title="' + value + '" style="font-size: 12px; cursor: pointer;">' + value + '</a>';
		            }
		        }],
		        onClickRow: function(row, $element) {
		            if (row.hospitalId) {
		                selectHospital(row.hospitalId);
		            }
		        },
		        rowStyle: function(row, index) {
		            if (selectedHospitalId && row.hospitalId == selectedHospitalId) {
		                return {classes: 'info'};
		            }
		            return {};
		        }
		    });
		    
		    console.log("医院表格初始化完成");
		    
		    // 初始化完成后加载数据（与supplier.html保持一致）
		    queryHospitalList();
		    } catch(e) {
		        console.error("初始化医院表格失败:", e);
		        console.error("错误堆栈:", e.stack);
		    }
		}
		
		// 查询所有医院列表（与supplier.html的querySupplierList保持一致）
		function queryHospitalList() {
		    var url = hospitalPrefix + "/all";
		    console.log("查询医院列表，URL:", url);
		    
		    $.ajax({
		        url: url,
		        type: "GET",
		        dataType: "json",
		        cache: false,
		        success: function(result) {
		            console.log("医院列表响应:", result);
		            if (result && result.code == 0) {
		                var hospitals = result.data || [];
		                console.log("医院数据数量:", hospitals.length);
		                if (hospitals.length > 0) {
		                    console.log("第一条医院数据:", hospitals[0]);
		                }
		                updateHospitalTable(hospitals);
		            } else {
		                console.warn("医院列表响应code不为0:", result);
		                updateHospitalTable([]);
		            }
		        },
		        error: function(xhr, status, error) {
		            console.error("获取医院列表失败:", {
		                status: status,
		                error: error,
		                statusCode: xhr.status,
		                responseText: xhr.responseText
		            });
		            updateHospitalTable([]);
		        }
		    });
		}
		
		// 清除医院搜索，显示所有医院
		function clearHospitalSearch() {
		    $('#hospital-search-input').val('');
		    queryHospitalList();
		}
		
		// 更新医院表格数据（与supplier.html的updateSupplierTable保持一致）
		function updateHospitalTable(hospitals) {
		    var $table = $('#bootstrap-table-hospital');
		    console.log("更新医院表格，表格元素数量:", $table.length, "医院数据数量:", hospitals ? hospitals.length : 0);
		    
		    if ($table.length === 0) {
		        console.warn("医院表格元素不存在，300ms后重试");
		        setTimeout(function() {
		            updateHospitalTable(hospitals);
		        }, 300);
		        return;
		    }
		    
		    try {
		        var tableOptions = $table.bootstrapTable('getOptions');
		        console.log("表格选项:", tableOptions ? "存在" : "不存在");
		        if (tableOptions) {
		            console.log("加载医院数据到表格，数量:", hospitals ? hospitals.length : 0);
		            $table.bootstrapTable('load', hospitals || []);
		            
		            // 验证数据是否加载成功
		            setTimeout(function() {
		                var loadedData = $table.bootstrapTable('getData');
		                console.log("表格加载后的数据数量:", loadedData ? loadedData.length : 0);
		                
		                // 加载后高亮选中的行
		                if (selectedHospitalId) {
		                    $table.find('tbody tr').each(function() {
		                        var rowData = $table.bootstrapTable('getData');
		                        var rowIndex = $(this).index();
		                        if (rowIndex >= 0 && rowIndex < rowData.length && rowData[rowIndex].hospitalId == selectedHospitalId) {
		                            $(this).addClass('info');
		                        }
		                    });
		                }
		            }, 100);
		        } else {
		            console.warn("表格未初始化，先初始化");
		            initHospitalTable();
		            setTimeout(function() {
		                if ($table.bootstrapTable('getOptions')) {
		                    console.log("初始化后加载医院数据");
		                    $table.bootstrapTable('load', hospitals || []);
		                }
		            }, 500);
		        }
		    } catch(e) {
		        console.error("更新医院表格失败:", e);
		        console.error("错误堆栈:", e.stack);
		    }
		}
		
		// 搜索医院
		function searchHospital() {
		    var searchText = $('#hospital-search-input').val().trim();
		    
		    if (!searchText) {
		        queryHospitalList();
		        return;
		    }
		    
		    var $table = $('#bootstrap-table-hospital');
		    if ($table.length === 0 || !$table.bootstrapTable('getOptions')) {
		        return;
		    }
		    
		    var allData = $table.bootstrapTable('getData');
		    var filteredData = allData.filter(function(row) {
		        var code = (row.hospitalCode || '').toLowerCase();
		        var name = (row.hospitalName || '').toLowerCase();
		        var keyword = searchText.toLowerCase();
		        return code.indexOf(keyword) !== -1 || name.indexOf(keyword) !== -1;
		    });
		    
		    $table.bootstrapTable('load', filteredData);
		}
		
		// 清空搜索
		function clearHospitalSearch() {
		    $('#hospital-search-input').val('');
		    queryHospitalList();
		}
		
		// 搜索框回车事件
		$(document).on('keypress', '#hospital-search-input', function(e) {
		    if (e.which === 13) {
		        searchHospital();
		    }
		});

		// 选择医院，加载该医院绑定的供应商证件
		function selectHospital(hospitalId) {
		    if (!hospitalId) {
		        // 取消选择，显示所有待审核的证件
		        selectedHospitalId = null;
		        selectedSupplierIds = [];
		        $('#bootstrap-table').bootstrapTable('refresh');
		        return;
		    }
		    
		    selectedHospitalId = hospitalId;
		    
		    // 获取该医院绑定的供应商ID列表
		    $.ajax({
		        url: hospitalPrefix + "/suppliers/" + hospitalId,
		        type: "GET",
		        dataType: "json",
		        success: function(result) {
		            if (result.code == 0) {
		                selectedSupplierIds = result.data || [];
		                
		                if (selectedSupplierIds.length === 0) {
		                    // 该医院没有绑定的供应商，清空表格
		                    $('#bootstrap-table').bootstrapTable('load', []);
		                    $.modal.msgWarning("该医院暂无绑定的供应商");
		                } else {
		                    // 刷新表格，后端会根据supplierIds参数查询
		                    $('#bootstrap-table').bootstrapTable('refresh');
		                }
		                
		                // 刷新医院列表以高亮选中的医院
		                queryHospitalList();
		            } else {
		                $.modal.alertError(result.msg || "获取供应商列表失败");
		            }
		        },
		        error: function(xhr, status, error) {
		            console.error("获取供应商列表失败:", error);
		            $.modal.alertError("获取供应商列表失败");
		        }
		    });
		}
		
		// 显示详情
		function showDetail(row) {
		    if (!row) {
		        $('#detail-panel').hide();
		        adjustSupplierTableHeight();
		        return;
		    }
		    
		    var tbody = $('#detail-tbody');
		    tbody.empty();
		    
		    // 格式化日期
		    function formatDate(value) {
		        if (!value) return '-';
		        if (typeof value === 'string' && value.indexOf('-') > -1) {
		            return value.split(' ')[0];
		        }
		        try {
		            var date = new Date(value);
		            if (isNaN(date.getTime())) return '-';
		            var year = date.getFullYear();
		            var month = String(date.getMonth() + 1).padStart(2, '0');
		            var day = String(date.getDate()).padStart(2, '0');
		            return year + '-' + month + '-' + day;
		        } catch(e) {
		            return '-';
		        }
		    }
		    
		    // 获取当前行的供应商ID和医院编码
		    var currentSupplierId = row.supplierId;
		    var currentHospitalCode = row.hospitalCode;
		    
		    // 从表格数据中筛选出供应商和医院完全一致的所有证件记录
		    var tableData = $('#bootstrap-table').bootstrapTable('getData');
		    var matchedCertificates = tableData.filter(function(item) {
		        return item.supplierId === currentSupplierId && 
		               item.hospitalCode === currentHospitalCode;
		    });
		    
		    // 如果没有匹配的记录，只显示当前行
		    if (matchedCertificates.length === 0) {
		        matchedCertificates = [row];
		    }
		    
		    // 生成详情表格的HTML
		    var html = '';
		    var options = $('#bootstrap-table').bootstrapTable('getOptions');
		    var pageSize = options.pageSize || 10;
		    var pageNumber = options.pageNumber || 1;
		    
		    for (var i = 0; i < matchedCertificates.length; i++) {
		        var cert = matchedCertificates[i];
		        
		        // 计算序号（基于当前行在表格中的位置）
		        var serialNumber = '-';
		        for (var j = 0; j < tableData.length; j++) {
		            if (tableData[j].certificateId === cert.certificateId) {
		                serialNumber = (pageNumber - 1) * pageSize + j + 1;
		                break;
		            }
		        }
		        
		        // 判断是否长期
		        var isLongTerm = '-';
		        if (cert.certificateName === '是' || (!cert.expireDate || cert.expireDate === '' || cert.expireDate === null)) {
		            isLongTerm = '是';
		        } else if (cert.certificateName === '否') {
		            isLongTerm = '否';
		        }
		        
		        // 证件图片预览按钮
		        var imageHtml = '-';
		        if (cert.certificateFile && cert.certificateFile.trim() !== '') {
		            var fileUrls = cert.certificateFile.trim();
		            var escapedUrls = fileUrls.replace(/'/g, "\\'").replace(/"/g, '&quot;');
		            imageHtml = '<a class="btn btn-info btn-xs" href="javascript:void(0)" onclick="previewCertificateImage(\'' + escapedUrls + '\')" title="预览证件图片"><i class="fa fa-eye"></i> 预览</a>';
		        } else {
		            imageHtml = '<span class="text-muted">未上传</span>';
		        }
		        
		        html += '<tr>';
		        html += '<td style="text-align: center;">' + serialNumber + '</td>';
		        html += '<td style="text-align: center;">' + (cert.certificateType || '-') + '</td>';
		        html += '<td style="text-align: center;">' + (cert.certificateNo || '-') + '</td>';
		        html += '<td style="text-align: center;">' + formatDate(cert.expireDate) + '</td>';
		        html += '<td style="text-align: center;">' + isLongTerm + '</td>';
		        html += '<td style="text-align: center;">' + imageHtml + '</td>';
		        html += '</tr>';
		    }
		    
		    tbody.html(html);
		    $('#detail-panel').show();
		}
		
		// 预览证件图片（支持多图片切换）
		function previewCertificateImage(imageUrls) {
		    // 转义HTML特殊字符，防止XSS攻击
		    function escapeHtml(text) {
		        var map = {
		            '&': '&amp;',
		            '<': '&lt;',
		            '>': '&gt;',
		            '"': '&quot;',
		            "'": '&#039;'
		        };
		        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
		    }
		    
		    // 解析图片URL（支持逗号分隔的多个URL）
		    var urlArray = [];
		    if (imageUrls && imageUrls.trim() !== '') {
		        var urls = imageUrls.split(',');
		        for (var i = 0; i < urls.length; i++) {
		            var url = urls[i].trim();
		            if (url) {
		                // 构建完整的图片URL
		                if (url.indexOf('http://') === 0 || url.indexOf('https://') === 0) {
		                    // 已经是绝对路径，直接使用
		                    urlArray.push(url);
		                } else if (url.indexOf('/') === 0) {
		                    // 相对路径（以/开头），添加上下文路径
		                    urlArray.push(ctx + url.substring(1));
		                } else {
		                    // 其他情况，添加上下文路径
		                    urlArray.push(ctx + url);
		                }
		            }
		        }
		    }
		    
		    if (urlArray.length === 0) {
		        $.modal.alertWarning("没有可预览的图片");
		        return;
		    }
		    
		    // 当前显示的图片索引
		    var currentIndex = 0;
		    
		    // 构建预览内容HTML
		    function buildPreviewContent() {
		        var currentUrl = escapeHtml(urlArray[currentIndex]);
		        var html = '<div style="text-align: center; padding: 20px; overflow: auto; height: 100%; position: relative;">';
		        
		        // 如果有多张图片，显示切换按钮和图片计数
		        if (urlArray.length > 1) {
		            html += '<div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; border-radius: 15px; z-index: 1000; font-size: 14px;">';
		            html += '第 ' + (currentIndex + 1) + ' 张 / 共 ' + urlArray.length + ' 张';
		            html += '</div>';
		            
		            // 上一张按钮
		            if (currentIndex > 0) {
		                html += '<button id="prev-image-btn" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 15px 20px; border-radius: 5px; cursor: pointer; font-size: 18px; z-index: 1000;" onmouseover="this.style.background=\'rgba(0,0,0,0.9)\'" onmouseout="this.style.background=\'rgba(0,0,0,0.7)\'">‹</button>';
		            }
		            
		            // 下一张按钮
		            if (currentIndex < urlArray.length - 1) {
		                html += '<button id="next-image-btn" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 15px 20px; border-radius: 5px; cursor: pointer; font-size: 18px; z-index: 1000;" onmouseover="this.style.background=\'rgba(0,0,0,0.9)\'" onmouseout="this.style.background=\'rgba(0,0,0,0.7)\'">›</button>';
		            }
		        }
		        
		        // 图片
		        html += '<img id="preview-image" src="' + currentUrl + '" style="max-width: 100%; max-height: calc(100% - 40px); cursor: pointer; margin-top: 30px;" ';
		        html += 'onclick="var img = this; if(img.style.maxWidth === \'none\') { img.style.maxWidth=\'100%\'; img.style.maxHeight=\'calc(100% - 40px)\'; } else { img.style.maxWidth=\'none\'; img.style.maxHeight=\'none\'; }" ';
		        html += 'onerror="this.onerror=null; this.src=\'' + ctx + 'img/error.png\';" />';
		        html += '</div>';
		        
		        return html;
		    }
		    
		    // 使用layer弹窗显示图片
		    if (typeof layer !== 'undefined') {
		        var layerIndex = layer.open({
		            type: 1,
		            title: '证件图片预览' + (urlArray.length > 1 ? '（' + urlArray.length + '张）' : ''),
		            shadeClose: true,
		            shade: 0.8,
		            area: ['90%', '90%'],
		            content: buildPreviewContent(),
		            success: function(layero, index) {
		                // 更新预览内容的函数
		                function updatePreview() {
		                    layero.find('.layui-layer-content').html(buildPreviewContent());
		                    // 重新绑定按钮事件
		                    bindButtonEvents();
		                }
		                
		                // 绑定切换按钮事件
		                function bindButtonEvents() {
		                    // 移除旧的事件监听
		                    layero.find('#prev-image-btn').off('click');
		                    layero.find('#next-image-btn').off('click');
		                    
		                    // 上一张
		                    layero.find('#prev-image-btn').on('click', function() {
		                        if (currentIndex > 0) {
		                            currentIndex--;
		                            updatePreview();
		                        }
		                    });
		                    
		                    // 下一张
		                    layero.find('#next-image-btn').on('click', function() {
		                        if (currentIndex < urlArray.length - 1) {
		                            currentIndex++;
		                            updatePreview();
		                        }
		                    });
		                }
		                
		                // 绑定切换按钮事件
		                if (urlArray.length > 1) {
		                    bindButtonEvents();
		                    
		                    // 键盘左右箭头切换
		                    $(document).on('keydown.preview', function(e) {
		                        if (e.keyCode === 37) { // 左箭头
		                            if (currentIndex > 0) {
		                                currentIndex--;
		                                updatePreview();
		                            }
		                        } else if (e.keyCode === 39) { // 右箭头
		                            if (currentIndex < urlArray.length - 1) {
		                                currentIndex++;
		                                updatePreview();
		                            }
		                        }
		                    });
		                }
		            },
		            end: function() {
		                // 关闭后移除键盘事件监听
		                $(document).off('keydown.preview');
		            }
		        });
		    } else {
		        // 如果layer不可用，使用新窗口打开第一张图片
		        window.open(urlArray[0], '_blank');
		    }
		}
		
		// 审核
		function auditCertificate() {
		    console.log("审核按钮被点击");
		    
		    var $table = $('#bootstrap-table');
		    
		    if ($table.length === 0) {
		        console.error("表格元素不存在");
		        $.modal.alertError("表格未初始化");
		        return;
		    }
		    
		    // 尝试多种方式获取选中行
		    var selections = $table.bootstrapTable('getSelections');
		    console.log("getSelections结果:", selections);
		    
		    // 如果getSelections为空，尝试通过复选框获取
		    if (!selections || selections.length === 0) {
		        var checkedRows = $table.find('tbody input[type="checkbox"]:checked').closest('tr');
		        console.log("通过复选框找到的行数:", checkedRows.length);
		        
		        if (checkedRows.length > 0) {
		            // 从表格数据中查找对应的行
		            var allData = $table.bootstrapTable('getData');
		            var checkedIndexes = [];
		            checkedRows.each(function() {
		                var index = $(this).data('index');
		                if (index !== undefined) {
		                    checkedIndexes.push(index);
		                }
		            });
		            
		            if (checkedIndexes.length > 0) {
		                selections = allData.filter(function(row, idx) {
		                    return checkedIndexes.indexOf(idx) !== -1;
		                });
		                console.log("通过索引找到的选中行:", selections);
		            }
		        }
		    }
		    
		    if (!selections || selections.length === 0) {
		        $.modal.alertWarning("请选择一条记录");
		        return;
		    }
		    
		    if (selections.length > 1) {
		        $.modal.alertWarning("请只选择一条记录");
		        return;
		    }
		    
		    var row = selections[0];
		    var certificateId = row.certificateId;
		    console.log("证件ID:", certificateId);
		    
		    if (!certificateId) {
		        console.error("无法获取证件ID，行数据:", row);
		        $.modal.alertError("无法获取证件ID");
		        return;
		    }
		    
		    // 弹出审核对话框
		    showAuditDialog(certificateId, row);
		}
		
		// 显示审核对话框
		function showAuditDialog(certificateId, row) {
		    var supplierName = row.supplierName || '未知供应商';
		    
		    // 创建审核对话框HTML
		    var dialogHtml = '<div style="padding: 20px;">' +
		        '<div class="form-group">' +
		        '<label>供应商：</label>' +
		        '<input type="text" class="form-control" value="' + supplierName + '" readonly style="margin-bottom: 10px;">' +
		        '</div>' +
		        '<div class="form-group">' +
		        '<label>审核状态：<span style="color: red;">*</span></label>' +
		        '<select id="audit-status-select" class="form-control" style="margin-bottom: 10px;">' +
		        '<option value="1">已审核</option>' +
		        '<option value="2">已拒绝</option>' +
		        '</select>' +
		        '</div>' +
		        '<div class="form-group">' +
		        '<label>审核备注：</label>' +
		        '<textarea id="audit-remark-textarea" class="form-control" rows="3" placeholder="请输入审核备注（可选）" maxlength="500"></textarea>' +
		        '</div>' +
		        '</div>';
		    
		    layer.open({
		        type: 1,
		        title: '审核供应商证件',
		        area: ['500px', '350px'],
		        content: dialogHtml,
		        btn: ['确定', '取消'],
		        yes: function(index, layero) {
		            var auditStatus = $('#audit-status-select').val();
		            var auditRemark = $('#audit-remark-textarea').val();
		            
		            if (!auditStatus) {
		                $.modal.alertWarning("请选择审核状态");
		                return false; // 阻止关闭弹窗
		            }
		            
		            // 执行审核
		            doAudit(certificateId, auditStatus, auditRemark, index);
		        },
		        btn2: function(index) {
		            layer.close(index);
		        }
		    });
		}
		
		// 执行审核
		function doAudit(certificateId, auditStatus, auditRemark, layerIndex) {
		    console.log("执行审核，参数:", {
		        certificateId: certificateId,
		        auditStatus: auditStatus,
		        auditRemark: auditRemark
		    });
		    
		    $.ajax({
		        url: prefix + "/audit",
		        type: "POST",
		        data: {
		            certificateId: certificateId,
		            auditStatus: auditStatus,
		            auditRemark: auditRemark || ''
		        },
		        success: function(result) {
		            console.log("审核接口返回结果:", result);
		            if (result.code == 0) {
		                // 关闭弹窗
		                if (layerIndex !== undefined) {
		                    layer.close(layerIndex);
		                }
		                $.modal.msgSuccess("审核成功");
		                // 刷新表格（延迟一下，确保数据库已更新）
		                setTimeout(function() {
		                    $('#bootstrap-table').bootstrapTable('refresh');
		                }, 500);
		            } else {
		                $.modal.alertError(result.msg || "审核失败");
		            }
		        },
		        error: function(xhr, status, error) {
		            console.error("审核失败:", error, xhr.responseText);
		            var errorMsg = "审核失败";
		            if (xhr.responseJSON && xhr.responseJSON.msg) {
		                errorMsg = xhr.responseJSON.msg;
		            } else if (xhr.responseText) {
		                errorMsg = xhr.responseText;
		            }
		            $.modal.alertError(errorMsg);
		        }
		    });
		}
		
		// 更新工具栏状态
		function updateToolbarState() {
		    var $table = $('#bootstrap-table');
		    if ($table.length === 0) {
		        return;
		    }
		    
		    // 尝试多种方式获取选中行
		    var selections = $table.bootstrapTable('getSelections');
		    
		    // 如果getSelections为空，尝试通过复选框获取
		    if (!selections || selections.length === 0) {
		        var checkedCount = $table.find('tbody input[type="checkbox"]:checked').length;
		        console.log("通过复选框找到的选中数:", checkedCount);
		        
		        if (checkedCount === 1) {
		            // 如果只有一个复选框被选中，尝试从表格数据中获取
		            var allData = $table.bootstrapTable('getData');
		            var checkedIndex = $table.find('tbody input[type="checkbox"]:checked').closest('tr').first().data('index');
		            if (checkedIndex !== undefined && allData[checkedIndex]) {
		                selections = [allData[checkedIndex]];
		            }
		        }
		    }
		    
		    console.log("更新工具栏状态，选中行数:", selections ? selections.length : 0);
		    
		    var $auditBtn = $('.single');
		    if (selections && selections.length === 1) {
		        $auditBtn.removeClass('disabled').prop('disabled', false);
		        console.log("启用审核按钮");
		    } else {
		        $auditBtn.addClass('disabled').prop('disabled', true);
		        console.log("禁用审核按钮");
		    }
		}
		
	</script>
</body>
</html>

