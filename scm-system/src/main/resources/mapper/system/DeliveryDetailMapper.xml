<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scm.system.mapper.DeliveryDetailMapper">
    
    <resultMap type="DeliveryDetail" id="DeliveryDetailResult">
        <id     property="detailId"          column="detail_id"          />
        <result property="deliveryId"       column="delivery_id"         />
        <result property="orderDetailId"    column="order_detail_id"     />
        <result property="materialId"       column="material_id"         />
        <result property="materialCode"     column="material_code"       />
        <result property="materialName"     column="material_name"       />
        <result property="specification"    column="specification"        />
        <result property="model"           column="model"              />
        <result property="unit"            column="unit"                />
        <result property="remainingQuantity" column="remaining_quantity" />
        <result property="deliveryQuantity" column="delivery_quantity"  />
        <result property="price"           column="price"                />
        <result property="amount"          column="amount"              />
        <result property="batchNo"         column="batch_no"            />
        <result property="productionDate"   column="production_date"     />
        <result property="expireDate"      column="expire_date"          />
        <result property="manufacturer"     column="manufacturer_name"   />
        <result property="registerNo"       column="register_no"         />
        <result property="deliveryNo"       column="delivery_no"         />
    </resultMap>
    
    <sql id="selectDeliveryDetailVo">
        select d.detail_id, d.delivery_id, d.order_detail_id, d.material_id, d.material_code,
               d.material_name, d.specification, d.model, d.unit, d.remaining_quantity,
               d.delivery_quantity, d.price, d.amount, d.batch_no, d.production_date,
               d.expire_date, d.manufacturer_name, d.register_no,
               del.delivery_no
        from scm_delivery_detail d
        left join scm_delivery del on d.delivery_id = del.delivery_id
    </sql>
    
    <select id="selectDeliveryDetailList" parameterType="DeliveryDetail" resultMap="DeliveryDetailResult">
        <include refid="selectDeliveryDetailVo"/>
        <where>
            <if test="deliveryId != null">
                AND d.delivery_id = #{deliveryId}
            </if>
            <if test="materialId != null">
                AND d.material_id = #{materialId}
            </if>
            <if test="materialCode != null and materialCode != ''">
                AND d.material_code like concat('%', #{materialCode}, '%')
            </if>
            <if test="materialName != null and materialName != ''">
                AND d.material_name like concat('%', #{materialName}, '%')
            </if>
            <if test="deliveryNo != null and deliveryNo != ''">
                AND del.delivery_no like concat('%', #{deliveryNo}, '%')
            </if>
        </where>
        order by d.detail_id desc
    </select>
    
    <select id="selectDeliveryDetailListByDeliveryId" parameterType="Long" resultMap="DeliveryDetailResult">
        <include refid="selectDeliveryDetailVo"/>
        where d.delivery_id = #{deliveryId}
        order by d.detail_id
    </select>
    
    <select id="selectDeliveryDetailById" parameterType="Long" resultMap="DeliveryDetailResult">
        <include refid="selectDeliveryDetailVo"/>
        where d.detail_id = #{detailId}
    </select>
    
    <insert id="insertDeliveryDetail" parameterType="DeliveryDetail" useGeneratedKeys="true" keyProperty="detailId">
        insert into scm_delivery_detail(
            <if test="deliveryId != null">delivery_id,</if>
            <if test="orderDetailId != null">order_detail_id,</if>
            <if test="materialId != null">material_id,</if>
            <if test="materialCode != null and materialCode != ''">material_code,</if>
            <if test="materialName != null and materialName != ''">material_name,</if>
            <if test="specification != null and specification != ''">specification,</if>
            <if test="model != null and model != ''">model,</if>
            <if test="unit != null and unit != ''">unit,</if>
            <if test="remainingQuantity != null">remaining_quantity,</if>
            <if test="deliveryQuantity != null">delivery_quantity,</if>
            <if test="price != null">price,</if>
            <if test="amount != null">amount,</if>
            <if test="batchNo != null and batchNo != ''">batch_no,</if>
            <if test="productionDate != null">production_date,</if>
            <if test="expireDate != null">expire_date,</if>
            <if test="manufacturer != null and manufacturer != ''">manufacturer_name,</if>
            <if test="registerNo != null and registerNo != ''">register_no,</if>
            create_time
        )values(
            <if test="deliveryId != null">#{deliveryId},</if>
            <if test="orderDetailId != null">#{orderDetailId},</if>
            <if test="materialId != null">#{materialId},</if>
            <if test="materialCode != null and materialCode != ''">#{materialCode},</if>
            <if test="materialName != null and materialName != ''">#{materialName},</if>
            <if test="specification != null and specification != ''">#{specification},</if>
            <if test="model != null and model != ''">#{model},</if>
            <if test="unit != null and unit != ''">#{unit},</if>
            <if test="remainingQuantity != null">#{remainingQuantity},</if>
            <if test="deliveryQuantity != null">#{deliveryQuantity},</if>
            <if test="price != null">#{price},</if>
            <if test="amount != null">#{amount},</if>
            <if test="batchNo != null and batchNo != ''">#{batchNo},</if>
            <if test="productionDate != null">#{productionDate},</if>
            <if test="expireDate != null">#{expireDate},</if>
            <if test="manufacturer != null and manufacturer != ''">#{manufacturer},</if>
            <if test="registerNo != null and registerNo != ''">#{registerNo},</if>
            sysdate()
        )
    </insert>
    
    <insert id="batchInsertDeliveryDetail" parameterType="java.util.List">
        insert into scm_delivery_detail(delivery_id, order_detail_id, material_id, material_code,
               material_name, specification, model, unit, remaining_quantity, delivery_quantity,
               price, amount, batch_no, production_date, expire_date, manufacturer_name, register_no, create_time)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.deliveryId}, #{item.orderDetailId}, #{item.materialId}, #{item.materialCode},
             #{item.materialName}, #{item.specification}, #{item.model}, #{item.unit},
             #{item.remainingQuantity}, #{item.deliveryQuantity}, #{item.price}, #{item.amount},
             #{item.batchNo}, #{item.productionDate}, #{item.expireDate}, #{item.manufacturer}, #{item.registerNo}, sysdate())
        </foreach>
    </insert>
    
    <update id="updateDeliveryDetail" parameterType="DeliveryDetail">
        update scm_delivery_detail
        <set>
            <if test="deliveryId != null">delivery_id = #{deliveryId},</if>
            <if test="orderDetailId != null">order_detail_id = #{orderDetailId},</if>
            <if test="materialId != null">material_id = #{materialId},</if>
            <if test="materialCode != null and materialCode != ''">material_code = #{materialCode},</if>
            <if test="materialName != null and materialName != ''">material_name = #{materialName},</if>
            <if test="specification != null and specification != ''">specification = #{specification},</if>
            <if test="model != null and model != ''">model = #{model},</if>
            <if test="unit != null and unit != ''">unit = #{unit},</if>
            <if test="remainingQuantity != null">remaining_quantity = #{remainingQuantity},</if>
            <if test="deliveryQuantity != null">delivery_quantity = #{deliveryQuantity},</if>
            <if test="price != null">price = #{price},</if>
            <if test="amount != null">amount = #{amount},</if>
            <if test="batchNo != null and batchNo != ''">batch_no = #{batchNo},</if>
            <if test="productionDate != null">production_date = #{productionDate},</if>
            <if test="expireDate != null">expire_date = #{expireDate},</if>
            <if test="manufacturer != null and manufacturer != ''">manufacturer_name = #{manufacturer},</if>
            <if test="registerNo != null and registerNo != ''">register_no = #{registerNo},</if>
        </set>
        where detail_id = #{detailId}
    </update>
    
    <delete id="deleteDeliveryDetailById" parameterType="Long">
        delete from scm_delivery_detail where detail_id = #{detailId}
    </delete>
    
    <delete id="deleteDeliveryDetailByDeliveryId" parameterType="Long">
        delete from scm_delivery_detail where delivery_id = #{deliveryId}
    </delete>
    
    <delete id="deleteDeliveryDetailByIds" parameterType="String">
        delete from scm_delivery_detail where detail_id in
        <foreach item="detailId" collection="array" open="(" separator="," close=")">
            #{detailId}
        </foreach>
    </delete>
</mapper>

