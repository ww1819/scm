<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scm.system.mapper.PurchaseStatisticsMapper">
    
    <resultMap type="PurchaseStatistics" id="PurchaseStatisticsResult">
        <id     property="statisticsId"      column="statistics_id"      />
        <result property="statisticsYear"    column="statistics_year"    />
        <result property="statisticsMonth"   column="statistics_month"   />
        <result property="hospitalId"        column="hospital_id"        />
        <result property="supplierId"        column="supplier_id"         />
        <result property="materialId"        column="material_id"         />
        <result property="purchaseQuantity"  column="purchase_quantity"   />
        <result property="purchaseAmount"    column="purchase_amount"     />
        <result property="orderCount"        column="order_count"         />
    </resultMap>
    
    <sql id="selectPurchaseStatisticsVo">
        select s.statistics_id, s.statistics_year, s.statistics_month, s.hospital_id, s.supplier_id,
               s.material_id, s.purchase_quantity, s.purchase_amount, s.order_count,
               h.hospital_name, sup.company_name as supplier_name, m.material_name
        from scm_purchase_statistics s
        left join scm_hospital h on s.hospital_id = h.hospital_id
        left join scm_supplier sup on s.supplier_id = sup.supplier_id
        left join scm_material_dict m on s.material_id = m.material_id
    </sql>
    
    <select id="selectPurchaseStatisticsList" parameterType="PurchaseStatistics" resultMap="PurchaseStatisticsResult">
        <include refid="selectPurchaseStatisticsVo"/>
        <where>
            <if test="statisticsYear != null">
                AND s.statistics_year = #{statisticsYear}
            </if>
            <if test="statisticsMonth != null">
                AND s.statistics_month = #{statisticsMonth}
            </if>
            <if test="hospitalId != null">
                AND s.hospital_id = #{hospitalId}
            </if>
            <if test="supplierId != null">
                AND s.supplier_id = #{supplierId}
            </if>
            <if test="materialId != null">
                AND s.material_id = #{materialId}
            </if>
        </where>
        order by s.statistics_year desc, s.statistics_month desc
    </select>
    
    <select id="selectPurchaseStatisticsById" parameterType="Long" resultMap="PurchaseStatisticsResult">
        <include refid="selectPurchaseStatisticsVo"/>
        where s.statistics_id = #{statisticsId}
    </select>
    
    <!-- 查询月采购量统计 -->
    <select id="selectMonthlyPurchaseStatistics" parameterType="java.util.Map" resultType="java.util.Map">
        select 
            DATE_FORMAT(o.order_date, '%Y-%m') as month,
            o.hospital_id,
            o.supplier_id,
            h.hospital_name,
            s.company_name as supplier_name,
            SUM(od.order_quantity) as total_quantity,
            SUM(od.amount) as total_amount,
            COUNT(DISTINCT o.order_id) as order_count
        from scm_order o
        left join scm_order_detail od on o.order_id = od.order_id
        left join scm_hospital h on o.hospital_id = h.hospital_id
        left join scm_supplier s on o.supplier_id = s.supplier_id
        <where>
            o.order_status != '4'
            <if test="year != null">
                AND YEAR(o.order_date) = #{year}
            </if>
            <if test="month != null">
                AND MONTH(o.order_date) = #{month}
            </if>
            <if test="hospitalId != null">
                AND o.hospital_id = #{hospitalId}
            </if>
            <if test="supplierId != null">
                AND o.supplier_id = #{supplierId}
            </if>
        </where>
        group by DATE_FORMAT(o.order_date, '%Y-%m'), o.hospital_id, o.supplier_id
        order by month desc
    </select>
    
    <!-- 查询年采购量统计 -->
    <select id="selectYearlyPurchaseStatistics" parameterType="java.util.Map" resultType="java.util.Map">
        select 
            YEAR(o.order_date) as year,
            o.hospital_id,
            o.supplier_id,
            h.hospital_name,
            s.company_name as supplier_name,
            SUM(od.order_quantity) as total_quantity,
            SUM(od.amount) as total_amount,
            COUNT(DISTINCT o.order_id) as order_count
        from scm_order o
        left join scm_order_detail od on o.order_id = od.order_id
        left join scm_hospital h on o.hospital_id = h.hospital_id
        left join scm_supplier s on o.supplier_id = s.supplier_id
        <where>
            o.order_status != '4'
            <if test="year != null">
                AND YEAR(o.order_date) = #{year}
            </if>
            <if test="hospitalId != null">
                AND o.hospital_id = #{hospitalId}
            </if>
            <if test="supplierId != null">
                AND o.supplier_id = #{supplierId}
            </if>
        </where>
        group by YEAR(o.order_date), o.hospital_id, o.supplier_id
        order by year desc
    </select>
    
    <!-- 查询采购数据分析报表 -->
    <select id="selectPurchaseAnalysisReport" parameterType="java.util.Map" resultType="java.util.Map">
        select 
            m.material_name,
            m.material_code,
            h.hospital_name,
            s.company_name as supplier_name,
            SUM(od.order_quantity) as total_quantity,
            SUM(od.amount) as total_amount,
            AVG(od.purchase_price) as avg_price,
            COUNT(DISTINCT o.order_id) as order_count
        from scm_order o
        left join scm_order_detail od on o.order_id = od.order_id
        left join scm_material_dict m on od.material_id = m.material_id
        left join scm_hospital h on o.hospital_id = h.hospital_id
        left join scm_supplier s on o.supplier_id = s.supplier_id
        <where>
            o.order_status != '4'
            <if test="beginTime != null and beginTime != ''">
                AND date(o.order_date) &gt;= date(#{beginTime})
            </if>
            <if test="endTime != null and endTime != ''">
                AND date(o.order_date) &lt;= date(#{endTime})
            </if>
            <if test="hospitalId != null">
                AND o.hospital_id = #{hospitalId}
            </if>
            <if test="supplierId != null">
                AND o.supplier_id = #{supplierId}
            </if>
            <if test="materialId != null">
                AND od.material_id = #{materialId}
            </if>
        </where>
        group by od.material_id, o.hospital_id, o.supplier_id
        order by total_amount desc
    </select>
    
    <insert id="insertPurchaseStatistics" parameterType="PurchaseStatistics" useGeneratedKeys="true" keyProperty="statisticsId">
        insert into scm_purchase_statistics(
            <if test="statisticsYear != null">statistics_year,</if>
            <if test="statisticsMonth != null">statistics_month,</if>
            <if test="hospitalId != null">hospital_id,</if>
            <if test="supplierId != null">supplier_id,</if>
            <if test="materialId != null">material_id,</if>
            <if test="purchaseQuantity != null">purchase_quantity,</if>
            <if test="purchaseAmount != null">purchase_amount,</if>
            <if test="orderCount != null">order_count,</if>
            create_time
        )values(
            <if test="statisticsYear != null">#{statisticsYear},</if>
            <if test="statisticsMonth != null">#{statisticsMonth},</if>
            <if test="hospitalId != null">#{hospitalId},</if>
            <if test="supplierId != null">#{supplierId},</if>
            <if test="materialId != null">#{materialId},</if>
            <if test="purchaseQuantity != null">#{purchaseQuantity},</if>
            <if test="purchaseAmount != null">#{purchaseAmount},</if>
            <if test="orderCount != null">#{orderCount},</if>
            sysdate()
        )
    </insert>
    
    <update id="updatePurchaseStatistics" parameterType="PurchaseStatistics">
        update scm_purchase_statistics
        <set>
            <if test="statisticsYear != null">statistics_year = #{statisticsYear},</if>
            <if test="statisticsMonth != null">statistics_month = #{statisticsMonth},</if>
            <if test="hospitalId != null">hospital_id = #{hospitalId},</if>
            <if test="supplierId != null">supplier_id = #{supplierId},</if>
            <if test="materialId != null">material_id = #{materialId},</if>
            <if test="purchaseQuantity != null">purchase_quantity = #{purchaseQuantity},</if>
            <if test="purchaseAmount != null">purchase_amount = #{purchaseAmount},</if>
            <if test="orderCount != null">order_count = #{orderCount},</if>
        </set>
        where statistics_id = #{statisticsId}
    </update>
    
    <delete id="deletePurchaseStatisticsById" parameterType="Long">
        delete from scm_purchase_statistics where statistics_id = #{statisticsId}
    </delete>
    
    <delete id="deletePurchaseStatisticsByIds" parameterType="String">
        delete from scm_purchase_statistics where statistics_id in
        <foreach item="statisticsId" collection="array" open="(" separator="," close=")">
            #{statisticsId}
        </foreach>
    </delete>
</mapper>

