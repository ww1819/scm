<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scm.system.mapper.ProductCertificateMapper">
    
    <resultMap type="ProductCertificate" id="ProductCertificateResult">
        <id     property="certificateId"     column="certificate_id"     />
        <result property="materialId"         column="material_id"         />
        <result property="materialName"        column="material_name"       />
        <result property="specification"      column="specification"       />
        <result property="model"              column="model"               />
        <result property="manufacturerName"   column="manufacturer_name"   />
        <result property="supplierId"        column="supplier_id"         />
        <result property="supplierName"      column="supplier_name"       />
        <result property="certificateType"   column="certificate_type"    />
        <result property="certificateName"   column="certificate_name"    />
        <result property="registerNo"        column="register_no"        />
        <result property="udiCode"           column="udi_code"            />
        <result property="pinyinCode"        column="pinyin_code"         />
        <result property="registerName"      column="register_name"       />
        <result property="registerDate"      column="register_date"       />
        <result property="registerIssueDate" column="register_issue_date" />
        <result property="expireDate"        column="expire_date"          />
        <result property="registerValidDate" column="register_valid_date" />
        <result property="bidPrice"          column="bid_price"           />
        <result property="salePrice"         column="sale_price"          />
        <result property="hospitalCode"      column="hospital_code"       />
        <result property="saleCustomer"      column="sale_customer"       />
        <result property="productCategory"   column="product_category"    />
        <result property="certificateFile"   column="certificate_file"     />
        <result property="auditStatus"      column="audit_status"        />
        <result property="auditBy"          column="audit_by"            />
        <result property="auditTime"        column="audit_time"          />
        <result property="auditRemark"      column="audit_remark"        />
        <result property="isExpired"        column="is_expired"          />
        <result property="isWarning"        column="is_warning"           />
        <result property="status"           column="status"              />
        <result property="createBy"         column="create_by"           />
        <result property="createTime"       column="create_time"          />
        <result property="updateBy"         column="update_by"           />
        <result property="updateTime"       column="update_time"          />
        <result property="remark"           column="remark"              />
    </resultMap>
    
    <sql id="selectProductCertificateVo">
        select c.certificate_id, c.material_id, c.supplier_id, c.certificate_type, c.certificate_name,
               c.register_no, c.udi_code, c.pinyin_code, c.register_name, c.register_date, 
               c.register_issue_date, c.expire_date, c.register_valid_date, c.bid_price, c.sale_price,
               c.hospital_code, c.sale_customer, c.product_category,
               c.certificate_file, c.audit_status, c.audit_by, c.audit_time, c.audit_remark, 
               c.is_expired, c.is_warning, c.status, c.create_by, c.create_time, c.update_by, c.update_time, c.remark,
               m.material_name, m.material_code, m.specification, m.model, m.unit, 
               m.purchase_price, m.status as material_status,
               man.manufacturer_name,
               s.company_name as supplier_name
        from scm_product_certificate c
        left join scm_material_dict m on c.material_id = m.material_id and m.del_flag = '0'
        left join scm_manufacturer man on m.manufacturer_id = man.manufacturer_id and man.del_flag = '0'
        left join scm_supplier s on c.supplier_id = s.supplier_id
    </sql>
    
    <select id="selectProductCertificateList" parameterType="ProductCertificate" resultMap="ProductCertificateResult">
        <include refid="selectProductCertificateVo"/>
        <where>
            c.status != '1'
            <if test="materialId != null">
                AND c.material_id = #{materialId}
            </if>
            <if test="supplierId != null">
                AND c.supplier_id = #{supplierId}
            </if>
            <if test="registerNo != null and registerNo != ''">
                AND c.register_no like concat('%', #{registerNo}, '%')
            </if>
            <if test="certificateType != null and certificateType != ''">
                AND c.certificate_type = #{certificateType}
            </if>
            <if test="auditStatus != null and auditStatus != ''">
                AND c.audit_status = #{auditStatus}
            </if>
            <if test="isExpired != null and isExpired != ''">
                AND c.is_expired = #{isExpired}
            </if>
            <if test="isWarning != null and isWarning != ''">
                AND c.is_warning = #{isWarning}
            </if>
        </where>
        order by c.expire_date asc
    </select>
    
    <select id="selectExpiringCertificateList" parameterType="ProductCertificate" resultMap="ProductCertificateResult">
        <include refid="selectProductCertificateVo"/>
        <where>
            c.status != '1'
            AND c.is_warning = '1'
            <if test="materialId != null">
                AND c.material_id = #{materialId}
            </if>
            <if test="supplierId != null">
                AND c.supplier_id = #{supplierId}
            </if>
        </where>
        order by c.expire_date asc
    </select>
    
    <select id="selectProductCertificateById" parameterType="Long" resultMap="ProductCertificateResult">
        <include refid="selectProductCertificateVo"/>
        where c.certificate_id = #{certificateId}
    </select>
    
    <insert id="insertProductCertificate" parameterType="ProductCertificate" useGeneratedKeys="true" keyProperty="certificateId">
        insert into scm_product_certificate(
            <if test="materialId != null">material_id,</if>
            supplier_id,
            <if test="certificateType != null and certificateType != ''">certificate_type,</if>
            <if test="certificateName != null and certificateName != ''">certificate_name,</if>
            <if test="registerNo != null and registerNo != ''">register_no,</if>
            <if test="udiCode != null and udiCode != ''">udi_code,</if>
            <if test="pinyinCode != null and pinyinCode != ''">pinyin_code,</if>
            <if test="registerName != null and registerName != ''">register_name,</if>
            <if test="registerDate != null">register_date,</if>
            <if test="registerIssueDate != null">register_issue_date,</if>
            <if test="expireDate != null">expire_date,</if>
            <if test="registerValidDate != null">register_valid_date,</if>
            <if test="bidPrice != null">bid_price,</if>
            <if test="salePrice != null">sale_price,</if>
            <if test="hospitalCode != null and hospitalCode != ''">hospital_code,</if>
            <if test="saleCustomer != null and saleCustomer != ''">sale_customer,</if>
            <if test="productCategory != null and productCategory != ''">product_category,</if>
            <if test="certificateFile != null and certificateFile != ''">certificate_file,</if>
            <if test="auditStatus != null and auditStatus != ''">audit_status,</if>
            <if test="auditBy != null and auditBy != ''">audit_by,</if>
            <if test="auditTime != null">audit_time,</if>
            <if test="auditRemark != null and auditRemark != ''">audit_remark,</if>
            <if test="isExpired != null and isExpired != ''">is_expired,</if>
            <if test="isWarning != null and isWarning != ''">is_warning,</if>
            <if test="status != null and status != ''">status,</if>
            <if test="remark != null and remark != ''">remark,</if>
            <if test="createBy != null and createBy != ''">create_by,</if>
            create_time
        )values(
            <if test="materialId != null">#{materialId},</if>
            #{supplierId},
            <if test="certificateType != null and certificateType != ''">#{certificateType},</if>
            <if test="certificateName != null and certificateName != ''">#{certificateName},</if>
            <if test="registerNo != null and registerNo != ''">#{registerNo},</if>
            <if test="udiCode != null and udiCode != ''">#{udiCode},</if>
            <if test="pinyinCode != null and pinyinCode != ''">#{pinyinCode},</if>
            <if test="registerName != null and registerName != ''">#{registerName},</if>
            <if test="registerDate != null">#{registerDate},</if>
            <if test="registerIssueDate != null">#{registerIssueDate},</if>
            <if test="expireDate != null">#{expireDate},</if>
            <if test="registerValidDate != null">#{registerValidDate},</if>
            <if test="bidPrice != null">#{bidPrice},</if>
            <if test="salePrice != null">#{salePrice},</if>
            <if test="hospitalCode != null and hospitalCode != ''">#{hospitalCode},</if>
            <if test="saleCustomer != null and saleCustomer != ''">#{saleCustomer},</if>
            <if test="productCategory != null and productCategory != ''">#{productCategory},</if>
            <if test="certificateFile != null and certificateFile != ''">#{certificateFile},</if>
            <if test="auditStatus != null and auditStatus != ''">#{auditStatus},</if>
            <if test="auditBy != null and auditBy != ''">#{auditBy},</if>
            <if test="auditTime != null">#{auditTime},</if>
            <if test="auditRemark != null and auditRemark != ''">#{auditRemark},</if>
            <if test="isExpired != null and isExpired != ''">#{isExpired},</if>
            <if test="isWarning != null and isWarning != ''">#{isWarning},</if>
            <if test="status != null and status != ''">#{status},</if>
            <if test="remark != null and remark != ''">#{remark},</if>
            <if test="createBy != null and createBy != ''">#{createBy},</if>
            sysdate()
        )
    </insert>
    
    <update id="updateProductCertificate" parameterType="ProductCertificate">
        update scm_product_certificate
        <set>
            <if test="materialId != null">material_id = #{materialId},</if>
            <if test="supplierId != null">supplier_id = #{supplierId},</if>
            <if test="certificateType != null and certificateType != ''">certificate_type = #{certificateType},</if>
            <if test="certificateName != null and certificateName != ''">certificate_name = #{certificateName},</if>
            <if test="registerNo != null and registerNo != ''">register_no = #{registerNo},</if>
            <if test="udiCode != null and udiCode != ''">udi_code = #{udiCode},</if>
            <if test="pinyinCode != null and pinyinCode != ''">pinyin_code = #{pinyinCode},</if>
            <if test="registerName != null and registerName != ''">register_name = #{registerName},</if>
            <if test="registerDate != null">register_date = #{registerDate},</if>
            <if test="registerIssueDate != null">register_issue_date = #{registerIssueDate},</if>
            <if test="expireDate != null">expire_date = #{expireDate},</if>
            <if test="registerValidDate != null">register_valid_date = #{registerValidDate},</if>
            <if test="bidPrice != null">bid_price = #{bidPrice},</if>
            <if test="salePrice != null">sale_price = #{salePrice},</if>
            <if test="hospitalCode != null and hospitalCode != ''">hospital_code = #{hospitalCode},</if>
            <if test="saleCustomer != null and saleCustomer != ''">sale_customer = #{saleCustomer},</if>
            <if test="productCategory != null and productCategory != ''">product_category = #{productCategory},</if>
            <if test="certificateFile != null and certificateFile != ''">certificate_file = #{certificateFile},</if>
            <if test="auditStatus != null and auditStatus != ''">audit_status = #{auditStatus},</if>
            <if test="auditBy != null and auditBy != ''">audit_by = #{auditBy},</if>
            <if test="auditTime != null">audit_time = #{auditTime},</if>
            <if test="auditRemark != null and auditRemark != ''">audit_remark = #{auditRemark},</if>
            <if test="isExpired != null and isExpired != ''">is_expired = #{isExpired},</if>
            <if test="isWarning != null and isWarning != ''">is_warning = #{isWarning},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="remark != null and remark != ''">remark = #{remark},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            update_time = sysdate()
        </set>
        where certificate_id = #{certificateId}
    </update>
    
    <update id="deleteProductCertificateById" parameterType="Long">
        update scm_product_certificate set status = '1' where certificate_id = #{certificateId}
    </update>
    
    <update id="deleteProductCertificateByIds" parameterType="String">
        update scm_product_certificate set status = '1' where certificate_id in
        <foreach item="certificateId" collection="array" open="(" separator="," close=")">
            #{certificateId}
        </foreach>
    </update>
    
    <!-- 根据厂家名称查找厂家ID -->
    <select id="findManufacturerByName" resultType="Long">
        SELECT manufacturer_id FROM scm_manufacturer 
        WHERE manufacturer_name = #{manufacturerName} AND del_flag = '0' 
        LIMIT 1
    </select>
    
    <!-- 创建厂家并返回ID -->
    <insert id="insertManufacturer">
        INSERT INTO scm_manufacturer (manufacturer_code, manufacturer_name, status, del_flag, create_by, create_time)
        VALUES (CONCAT('MAN', UNIX_TIMESTAMP(), FLOOR(RAND() * 10000)), #{manufacturerName}, '0', '0', #{createBy}, sysdate())
    </insert>
    
    <!-- 获取最后插入的厂家ID -->
    <select id="getLastInsertManufacturerId" resultType="Long">
        SELECT LAST_INSERT_ID()
    </select>
</mapper>

